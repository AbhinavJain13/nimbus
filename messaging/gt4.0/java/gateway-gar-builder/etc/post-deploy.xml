<?xml version="1.0"?>

<project default="setup" basedir="." name="post-deploy">

    <!-- ***********************************************************************
         PROPS
         ******************************************************************* -->

    <property environment="env" />
    <property name="env.GLOBUS_LOCATION" value="."/>
    <property name="deploy.dir" location="${env.GLOBUS_LOCATION}"/>

    <property name="base.package.name"
              value="nimbus-gateway" />

    <property name="base.conf.dir"
              value="${deploy.dir}/etc/${base.package.name}" />

    <property name="gateway.conf.dir"
              value="${base.conf.dir}/gateway" />

    <property name="ec2client.conf.dir"
              value="${base.conf.dir}/ec2client" />

    <property name="base.persistence.dir"
              value="${deploy.dir}/var/${base.package.name}" />

    <property name="dbsetup.dir"
              location="${deploy.dir}/share/${base.package.name}"/>

    <property name="dbsetup.antfile"
              location="${dbsetup.dir}/lib/db-mgmt.xml"/>

    <property name="build.launcher"
            location="${deploy.dir}/share/globus_wsrf_common/build-launcher.xml"/>

    
    <!-- replace absolute path tokens in these config files: -->
    
    <property name="jndi.path"
              location="${base.conf.dir}/jndi-config.xml"/>
    
    <property name="jndi.tmp"
              location="${base.conf.dir}/jndi-config.xml.tmp"/>

    <property name="gproperties.path"
              location="${gateway.conf.dir}/other/main.conflocator.xml"/>

    <property name="gproperties.tmp"
              location="${gateway.conf.dir}/other/main.conflocator.xml.tmp"/>
    
    <property name="ec2client.props.path"
              location="${ec2client.conf.dir}/other/main.conflocator.xml"/>

    <property name="ec2client.props.tmp"
              location="${ec2client.conf.dir}/other/main.conflocator.xml.tmp"/>

    <property name="ec2client2.props.path"
              location="${ec2client.conf.dir}/other/common.conf"/>

    <property name="ec2client2.props.tmp"
              location="${ec2client.conf.dir}/other/common.conf.tmp"/>

    <filterset id="absPathFilter">
        <filter token="EC2CLIENT_CONFDIR"
                value="${ec2client.conf.dir}"/>
        <filter token="GATEWAY_CONFDIR"
                value="${gateway.conf.dir}"/>
        <filter token="GATEWAY_PERSISTENCEDIR"
                value="${base.persistence.dir}"/>
        <filter token="DERBY_DIR"
                value="${deploy.dir}/var"/>
    </filterset>

    
    <!-- ***********************************************************************
         SETUP FOR CALLING db-mgmt.xml
         ******************************************************************* -->

    <!-- Write a properties file so that subsequent standalone invocations
         of db-mgmt.xml will work too -->
    <target name="create-db-props">
        <propertyfile file="${dbsetup.dir}/gateway.persistence.conf"
                      comment="Autogenerated by post-deploy">

            <entry key="gateway.dbdir.prop"
                   value="${base.persistence.dir}" />
            <entry key="gateway.sqldir.prop"
                   value="${dbsetup.dir}/lib" />
            <entry key="derby.system.home.prop"
                   value="${deploy.dir}/var" />
            <entry key="derby.relative.dir.prop"
                   value="${base.package.name}" />
            <entry key="derby.classpath.dir.prop"
                   value="${deploy.dir}/lib" />
            
        </propertyfile>
    </target>


    <!-- ***********************************************************************
         TARGET INVOKED AFTER GAR DEPLOYS
         ******************************************************************* -->

    <target name="setup"
            depends="adjust-gatewayprops, adjust-ec2clientprops,
                     adjust-ec2clientprops2, adjust-jndi,
                     chmodprivate, chmodexes, setupGatewayPersistence" />


    <!-- ***********************************************************************
         CALL OUT TO db-mgmt.xml
         ******************************************************************* -->

    <target name="setupGatewayPersistence" depends="create-db-props">

        <!-- that properties file is not picked up if just written, manually
             passing in the properties -->
        <property name="gateway.dbdir.prop"
                  value="${base.persistence.dir}" />
        <property name="gateway.sqldir.prop"
                  value="${dbsetup.dir}/lib" />
        <property name="derby.system.home.prop"
                  value="${deploy.dir}/var" />
        <property name="derby.relative.dir.prop"
                  value="${base.package.name}" />
        <property name="derby.classpath.dir.prop"
                  value="${deploy.dir}/lib" />

        <ant antfile="${dbsetup.antfile}" target="setupGatewayPersistence" />
    </target>
    

    <!-- ***********************************************************************
         POST-DEPLOY WORK
         ******************************************************************* -->

    <target name="chmodexes">
        <chmod perm="755">
            <fileset dir="${dbsetup.dir}">
                <include name="*.sh"/>
            </fileset>
        </chmod>
    </target>

    <target name="chmodprivate">
    </target>

    <target name="adjust-jndi">
        <copy file="${jndi.path}" toFile="${jndi.tmp}">
            <filterset refid="absPathFilter"/>
        </copy>
        <copy file="${jndi.tmp}" toFile="${jndi.path}"
              overwrite="true" />
        <delete file="${jndi.tmp}"/>
        <echo message="Adjusted JNDI config paths"/>
    </target>

    <target name="adjust-gatewayprops">
        <copy file="${gproperties.path}" toFile="${gproperties.tmp}">
            <filterset refid="absPathFilter"/>
        </copy>
        <copy file="${gproperties.tmp}" toFile="${gproperties.path}"
              overwrite="true" />
        <delete file="${gproperties.tmp}"/>
        <echo message="Adjusted gateway conf-locator paths"/>
    </target>

    <target name="adjust-ec2clientprops">
        <copy file="${ec2client.props.path}" toFile="${ec2client.props.tmp}">
            <filterset refid="absPathFilter"/>
        </copy>
        <copy file="${ec2client.props.tmp}" toFile="${ec2client.props.path}"
              overwrite="true" />
        <delete file="${ec2client.props.tmp}"/>
        <echo message="Adjusted ec2client conf-locator paths"/>
    </target>

    <target name="adjust-ec2clientprops2">
        <copy file="${ec2client2.props.path}" toFile="${ec2client2.props.tmp}">
            <filterset refid="absPathFilter"/>
        </copy>
        <copy file="${ec2client2.props.tmp}" toFile="${ec2client2.props.path}"
              overwrite="true" />
        <delete file="${ec2client2.props.tmp}"/>
        <echo message="Adjusted ec2client common.conf paths"/>
    </target>

</project>

